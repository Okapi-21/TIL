## ユーザー登録

------

### gem 'sorcery'

 Railsアプリケーションにおける認証システムの実装を支援するライブラリ。ログイン、ログアウト、セッション管理などの基本的な認証機能を簡単に追加することが可能になる。

```ruby
gem 'sorcery', '0.16.3'
```

導入後に必要なコマンド

```
docker compose run web rails g sorcery:install
```

・Userモデル・マイグレーションファイルが自動生成される（下記参照）

マイグレーションファイル の記述も以下に記述しておく

```ruby
class SorceryCore < ActiveRecord::Migration[7.0]
  def change
    create_table :users do |t|
      t.string :email,            null: false, index: { unique: true }
      t.string :crypted_password
      t.string :salt
      t.string :first_name,       null: false
      t.string :last_name,        null: false

      t.timestamps                null: false
    end
  end
end
```



Rails のモデルクラスはDBテーブルの定義を読み込んで動作するため、モデルを作成する場合は、まずはDBのテーブル追加から行うとスムーズ

モデルの設定を行う

```ruby
lass User < ApplicationRecord
  authenticates_with_sorcery!

  validates :password, length: { minimum: 3 }, if: -> { new_record? || changes[:crypted_password] }　
  validates :password, confirmation: true, if: -> { new_record? || changes[:crypted_password] }
  validates :password_confirmation, presence: true, if: -> { new_record? || changes[:crypted_password] }
  validates :first_name, presence: true, length: { maximum: 255 }
  validates :last_name, presence: true, length: { maximum: 255 }
  validates :email, presence: true, uniqueness: true
end
```

if: ~ 以降は条件付きバリデーションであり、新規登録時のみ適応されるように設定されている（不要なバリデーションエラーを出さないため）

バリデーション機能一覧

| 検証内容                                                     |          ヘルパーの使い方の例          |
| :----------------------------------------------------------- | :------------------------------------: |
| 必須のデータが入っているか                                   |     validates :foo, presence: true     |
| 数値を期待しているところに数値以外の値が入っていないか       |   validates :foo, numerically: true    |
| （数値の）範囲が適切か                                       |  validates :foo, inclusion: {in 0..9}  |
| 文字列の長さは適切か                                         | validates :foo, length: { maximum: 30} |
| データは一意か                                               |    validates :foo, uniqueness: true    |
| パスワードやメールアドレスがその確認用と内容が一致しているか |   validates :foo, confirmation: true   |

