## デプロイ関連

------

#### 環境変数について

　環境変数とは一言で言えば「プログラムの実行環境ごとに設定することができる変数」であり、開発環境や本番環境で異なる設定（DBのパスワードやAPIキーなど）を、ソースコードに直接書かずに、外部から渡すために使われるもの。環境を構築する際に、その設定値を定義することのできる変数なので「環境変数」と呼ばれる。
　環境変数と機密性の関連について、機密情報を「どこで・誰が」管理するのか、という視点が重要になる。環境変数をサーバーやクラウドで管理する場合は、サーバーへのアクセス権を制御することで機密情報が保たれるし、デプロイ時にはCI/CDにより機密情報をシークレット化して渡すことにより、安全性が確保されている。
　なので、環境構築時に環境変数が正しく設定されていないことはエラーの原因となる。特に、railsのマスターキーに関するエラーは本番環境構築時によく発生する（私の場合は発生した）。主なケースとして、①「master.key」ファイルが存在しておらず、本番環境で`RAILS_MASTER_KEY`環境変数が未設定となり、credentials（アプリケーションの機密情報（APIキーやパスワードなど）を安全に管理するための仕組み)の照合に失敗し、railsアプリが起動しない、②「master.key」か「credentials.yml.enc」のどちらかを上書きし、鍵穴とキーが合致しなくなり、照合に失敗し、railsアプリが起動しなくなるものがある（私はどちらもやった...）。
　エラーが生じた場合は、「master.key」か「credentials.yml.enc」のペアが揃っているか確認し、ずれていた場合はどちらも再生成するしかない。

エラーが発生した時の解決策

①既存のファイルを削除
```
rm config/credentials.yml.enc config/master.key
```

②新しくcredentialsを作成

```
EDITOR=vim bin/rails credentials:edit
```

　→ コマンド実行で「master.key」と「credentials.yml.enc」が自動生成

③必要な情報を入力して保存

　エディタが開いたら、必要な機密情報（APIキーなど）を記入し、保存して終了。

＊`master.key`は.gitignoreでGit管理から除外されていることを確認するのも忘れずに！！