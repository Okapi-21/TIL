## メールサーバ構築（virtual_user編）

# STEP1: SQLのDB設定

# STEP2: DovecotのSQL認証設定

## 意味・目的
Dovecot（メール認証サーバー）にバーチャルユーザーDB（SQL）を使わせる設定を行うことで、DBに登録したメールアドレス/パスワードで認証できるようになる。

---

## 1. `/etc/dovecot/dovecot-sql.conf.ext` の作成・編集

このファイルに「DB接続情報」「認証クエリ」を記載する。

```ini
driver = mysql
connect = host=localhost dbname=mailserver user=mailuser password=mailpassword

default_pass_scheme = SHA512-CRYPT

password_query = SELECT email AS user, password FROM virtual_users WHERE email = '%u';
user_query = SELECT email AS user, '/var/mail/vmail/%d/%n' AS home, 'vmail' AS uid, 'vmail' AS gid FROM virtual_users WHERE email = '%u';
```

---

## 2. パーミッション設定

セキュリティのため、ファイル所有者・権限を下記コマンドで変更する。

```bash
sudo chown root:dovecot /etc/dovecot/dovecot-sql.conf.ext
sudo chmod 600 /etc/dovecot/dovecot-sql.conf.ext
```

---

## 3. `/etc/dovecot/conf.d/10-auth.conf` の編集

下記の記述が有効になっていることを確認（コメントアウトされていれば外す）。

```conf
!include auth-sql.conf.ext
```

---

## 4. `/etc/dovecot/conf.d/auth-sql.conf.ext` の確認

ファイル内で以下の記述があることを確認。

```
args = /etc/dovecot/dovecot-sql.conf.ext
```

---

## 5. Dovecotの設定再読み込み/再起動

設定反映のため、下記コマンドでDovecotをリロードまたは再起動する。

```bash
sudo systemctl reload dovecot
# または
sudo systemctl restart dovecot
```

---

## 補足
- DB接続情報（DB名/ユーザー/パスワード）は自身の環境に合わせて設定する。
- メールボックスのディレクトリやuid/gidは、今後の工程で作成・調整する。